---
title: "Data Preparation"
author: "DARS"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(tidytext) 

library(gsheet) # import spreadsheets from google drive
library(tm)
library(hunspell) # Stemmer
```

# Import Data
The datasets we use are saved as spreadsheet on our google drive *DARS*. We use the function `gsheet2tbl` to import them to `R Studio` as tibbles. We use the tibble data format (an evolution of the data frame format) because this is the format of reference of the `tidyverse` on whose tools our analysis is heavily based.

## Setup
Before importing the spreadsheets from the drive, let us create two vectors `list_assessment` and `list_AoD` which respectively list the `19` types of assessment and the `18` aims of the degree (AoD) of the degree which we take into consideration in the analysis. The information comes from a spreadsheet from our google drive *DARS* which we save as `lists`. In addition, we also create two additional vectors `list_assessment_plot` and `list_AoD_plot` which contain a selection of prominent assessment types and AoD that we will consider when ploting the data[^1].
```{r list}
lists_brut <- gsheet2tbl('https://docs.google.com/spreadsheets/d/1soRA1u5zf9oLNirGmZ9yZ7m2ccPa3XFemnxkj5AVRXo/edit#gid=1239912347')

lists <- list(
  Assessment      = lists_brut$Assessment,
  Assessment_plot = lists_brut$Assessment[lists_brut$`Assessment for Plot` == 1],
  AoD             = lists_brut$Aim[!is.na(lists_brut$Aim)],
  AoD_plot        = lists_brut$Aim[lists_brut$`Aim for Plot`[!is.na(lists_brut$Aim)] == 1]
  )
```

## Course Data
We import three spreadsheets from the drive and transform them into the so-called *tidy format*. The tibble `d_course` contains information at the course-level such as in which cluster and concentration(s) they belong and in which period(s) they are offered, the tibble `d_assessment` indicates which type(s) of assessment each course contains with one row per course-assessment and the tibble `d_ILO` indicates which AoD(s) the intended learning objectives (ILOs) of the courses cover with one row per course-ILO-AoD.

```{r import data from drive}
d_course <- gsheet2tbl('https://docs.google.com/spreadsheets/d/1soRA1u5zf9oLNirGmZ9yZ7m2ccPa3XFemnxkj5AVRXo/edit#gid=1655700848') %>%
  mutate(`Missing from ILO File` = as.logical(`Missing from ILO File`))
print(d_course)

d_assessment <- gsheet2tbl('https://docs.google.com/spreadsheets/d/1soRA1u5zf9oLNirGmZ9yZ7m2ccPa3XFemnxkj5AVRXo/edit#gid=1102665750') %>%
  select(- `Comment on Assessment`) %>%
  gather(Assessment, assessment_covered, - Code, factor_key = T) %>%
  mutate(assessment_covered = as.logical(assessment_covered)) %>%
  filter(assessment_covered) %>%
  select(- assessment_covered) %>%
  arrange(Code)
print(d_assessment)

d_ILO <- gsheet2tbl('https://docs.google.com/spreadsheets/d/1soRA1u5zf9oLNirGmZ9yZ7m2ccPa3XFemnxkj5AVRXo/edit#gid=1896457050') %>%
  select(- c(Comments, Comments_for_Jeroen)) %>%
  gather(AoD, AoD_covered, -c(Code, Objectives), factor_key = T) %>%
  mutate(AoD_covered = as.logical(AoD_covered)) %>%
  rename(ILO = Objectives) %>%
  filter(AoD_covered) %>%
  select(- AoD_covered) %>%
  arrange(Code)
print(d_ILO)
```

## Textual Data

### Course Catalogues
In order to conduct a preliminary topic modeling of course content, we first analyze their description in the course catalogues. The corpus `corpus` contains the pdfs of the `5` most recent course catalogues.
```{r corpus, cache = TRUE}
corpus <- Corpus(x             = DirSource("Catalogues"),
                 readerControl = list(reader = readPDF(control = list(text = "-layout"))))
```

### Course Manuals
To expand our topic modeling of course content, we would like to analyse the material in the course manuals. The `corpus_manuals` contains the pdfs of the course manuals for the year 2017-2018 (most recently, available).
```{r}
corpus_manuals <- Corpus(x             = DirSource("Manuals 2017-18"),
                 readerControl = list(reader = readPDF(control = list(text = "-layout"))))
```
## Student Data
The tibble `transcripts` contains the transcripts of a selection of `7` alumni students from the college[^2]. `transcripts` contains information on each course taken by each student such as the receives grade, the semester in which teh course was taken as well as the calendar year.
```{r transcripts}
transcripts <- gsheet2tbl('https://docs.google.com/spreadsheets/d/1kj7tlfJAoN0F7IdoS3saT-2iC3nuDLwnDItNtCKoZ4k/edit#gid=936718979')
print(transcripts)
```

# Variable Engineering

## AoD
In this analysis, we conside that a course can cover an AoD in two ways: a course covers an AoD if one of its ILOs covers it or if one of its assessments cover it. For instance, if one of the ILO of a course states that the students will learn to analyze empirical data in the context of academic research, then the course in question covers the AoD `Research Skills`; and if one of the assessment is a group presentation, then the course also covers the AoD `Collaborative Skills` and `Communication Skills`.

### AoD from ILOs
In order to determine which AoD each course covers with its ILOs, we first eliminate the AoD that are not covered by the ILOs and then we take the unique combination of course and AoD in case a course had several ILOs covering the same AoD.
```{r}
d_AoD_ILO <- d_ILO %>%
  select(Code, AoD) %>%
  unique

print(d_AoD_ILO)
```

### AoD from Assessment Type
In order to determine which AoD each course covers with its assessments, we need to create a binary matrix which indicates which AoD(s) each assessment type covers. We have created such matrix on our google drive and we save it in the following piece of code as `map_assessment_AoD`. `map_assessment_AoD` indicates that, for instance, the assessment type `Essay` covers the AoD `Critical Thinking Skills`, `Communication Skills` and `Writing Skill`.
```{r}
map_assessment_AoD <- as.matrix(gsheet2tbl('https://docs.google.com/spreadsheets/d/1soRA1u5zf9oLNirGmZ9yZ7m2ccPa3XFemnxkj5AVRXo/edit#gid=719531216')[,lists$AoD] %>%
                                  mutate_all(as.logical))
rownames(map_assessment_AoD) <- lists$Assessment
print(map_assessment_AoD[1:5, 8:12])
```

Now that we have the matrix `map_assessment_AoD`, we create the tibble `d_assessment_clean` which only contains the assessments that are covered by each course and we loop through its rows to determine which AoD, each assessment covers. In the loop, we first extract the row of `d_assessment_clean` and save it as `observation` and determine the corresponding assessment which we save as `assessment`. Then we use the matrix `map_assessment_AoD` to determine which AoD `assessment` covers and use `cbind` and `rbind` to add the information to the tibble `d_AoD_assessment`.
```{r}
d_AoD_assessment <- tibble(Code        = character(0),
                           Assessment  = character(0),
                           AoD         = character(0))

for(i in 1 : nrow(d_assessment)){
  
  observation <- d_assessment[i, ]
  
  assessment  <- observation$Assessment
  AoD_covered <- map_assessment_AoD[assessment, ]
  AoD         <- lists$AoD[AoD_covered]
  
  if(length(AoD) >= 1){ # if no AoD are covered by assessment (e.g. written exam), then do not rbind rows to d_AoD_assessment
      AoD_assessment_tidy <- cbind(observation, AoD) %>%
    as_tibble
      d_AoD_assessment <- rbind(d_AoD_assessment, AoD_assessment_tidy)
  }

}

print(d_AoD_assessment)
```

Similarly to what we did with the tibble `d_AoD_ILO`, we first eliminate the AoD that are not covered by the assessments and then we take the unique combination of course and AoD in case a course had several assessments covering the same AoD.
```{r}
d_AoD_assessment <- d_AoD_assessment %>%
  select(Code, AoD) %>%
  unique
print(d_AoD_assessment)
```

### Combining AoD from ILOs and from assessments
Finally, we can use a `rbind` to combine the two tibbles `d_AoD_ILO` and `d_AoD_assessment`. We also use `unique` in case a course covers an AoD with both its ILOS and its assessments.
```{r}
d_AoD <- rbind(d_AoD_ILO, d_AoD_assessment) %>%
  unique %>%
  arrange(Code)
print(d_AoD)
```

## Course Manual 
We create a dataframe from the Corpus:
```{r}

manuals_td <- tidy(corpus_manuals)

```

# Save Data

