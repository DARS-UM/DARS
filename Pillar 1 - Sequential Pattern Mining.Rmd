---
title: "Pillar 1 - Sequential Pattern Mining"
author: "DARS"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: TRUE
---

```{r library, message = F}
library(tidyverse)
library(arules)
```

# Setup
```{r}
load("data_pillar_1.RDATA")
```

#Getting dates
For a first exploration of arules, we conceptualise our framework like this:
transaction = student
item = course

##Data preparation
First we transform our data into transaction data. For this, we first create a vector of mandatory courses that we exclude from transcripts. 

```{r}
d_transactions <- d_course %>%
  select(Type, Code, Letters) %>%
  filter(Type == "Elective",
         ! Letters %in% c("SKI", "PRO"),
         ! Letters %in% c("SAS", "SAH", "SAC")) %>%
  select(Code) %>%
  left_join(d_transcript, by = c("Code" = "Course Code")) %>%
  select(`Student ID Number`, Code) %>%
  group_by(`Student ID Number`) %>%
  summarize(list_course = list(Code)) %>%
  group_by()

transactions <- as(d_transactions$list_course, "transactions")
```

We apply Apriori algorithm:
```{r}
results <- apriori(
  data = transactions, 
  parameter = list(
    supp = 0.02,
    smax = 1, # max support
    conf = 0.4,
    minlen = 2,
    maxlen = 2
    ),
  appearance = NULL,
  control = NULL
  ) %>%
  inspect

colnames(results)[2] <- "association"

results %>%
  arrange(desc(confidence))
```

```{r}
d_transcript %>% filter(`Course Code`=="SSC3016")
```

Now we include data for pass and fail

```{r}
d_transaction_passed <- d_course %>%
  select(Type, Code, Letters) %>%
  filter(Type == "Elective",
         ! Letters %in% c("SKI", "PRO"),
         ! Letters %in% c("SAS", "SAH", "SAC")) %>%
  select(Code) %>%
  left_join(d_transcript, by = c("Code" = "Course Code")) %>%
  mutate(Outcome = case_when(Grade > 5.5 ~"Pass",
                             T~"Fail")) %>%
  mutate(Item= paste(Code, Outcome, sep = "_")) %>%
  select(`Student ID Number`, Item) %>%
  group_by(`Student ID Number`) %>%
  summarize(list_course = list(Item)) %>%
  group_by()

transactions_passed <- as(d_transaction_passed$list_course, "transactions")

```
We apply Apriori algorithm:
```{r}
results_passed <- apriori(
  data = transactions_passed, 
  parameter = list(
    supp = 0,
    smax = 1, # max support
    conf = 0.4,
    minlen = 2,
    maxlen = 2
    ),
  appearance = NULL,
  control = NULL
  ) %>%
  inspect

colnames(results_passed)[2] <- "association"

results_passed %>%
  separate(lhs, into = c("LHS", "LHS_pass"), sep= "_", remove = F) %>%
  separate(rhs, into = c("RHS", "RHS_pass"), sep= "_", remove = F) %>%
  filter(RHS_pass == "Fail}") %>%
  arrange(desc(count))
```










