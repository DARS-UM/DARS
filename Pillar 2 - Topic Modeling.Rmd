---
title: "Pillar 2 - Topic Modeling"
author: "DARS"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: TRUE
---

```{r library, message = F}
library(tidyverse)
library(tidytext)

library(ggwordcloud) # Word Clouds
library(topicmodels)
library(lemon)
library(ggthemes)
```

```{r function reorder_within & co., echo = FALSE}

# Function for ordering within facet:
# https://github.com/dgrtwo/drlib/blob/master/R/reorder_within.R

reorder_within <- function(x, by, within, fun = mean, sep = "___", ...) {
  new_x <- paste(x, within, sep = sep)
  stats::reorder(new_x, by, FUN = fun)
}

scale_x_reordered <- function(..., sep = "___") {
  reg <- paste0(sep, ".+$")
  ggplot2::scale_x_discrete(labels = function(x) gsub(reg, "", x), ...)
}

scale_y_reordered <- function(..., sep = "___") {
  reg <- paste0(sep, ".+$")
  ggplot2::scale_y_discrete(labels = function(x) gsub(reg, "", x), ...)
}
```

# Setup
```{r}
load("data_pillar_2.RDATA")
```

# TF-IDF
## Functions for Generating Barplots and Word Clouds
```{r function make_barplot and make_WC, out.height=8, out.width=16}
make_barplot <- function(data, facet, n_col = 5){
  
  facet <- enquo(facet)
  
  g <- data %>%
    rename(facet = !!facet) %>%
    ggplot(aes(reorder_within(word, tf_idf, facet), tf_idf)) +
    geom_col(show.legend = F) +
    labs(x = NULL, y = "tf-idf") +
    scale_x_reordered() +
    facet_wrap(~ facet, scales = "free", ncol = n_col) +
    coord_flip()
  
  ggsave(paste(facet[2], "_BP.jpeg", sep = ""), path = "Plots")
  return(g)
  
}

make_WC <- function(data, facet, n_col = 5){
  
  facet <- enquo(facet)
  
  g <- data %>%
    rename(facet = !!facet) %>%
    group_by(facet) %>%
    mutate(freq = tf_idf / sum(tf_idf)) %>% # normalization within clusters
    ungroup() %>%
    mutate(angle = 10 * sample(-2:2, n(), replace = T, prob = c(1,1,4,1,1))) %>%
    
    ggplot(aes(size = freq^0.7, label = word, 
               angle = angle, color = freq^0.7)) +
    geom_text_wordcloud_area(area_corr_power = 1,
                             eccentricity    = 1,
                             rm_outside      = T) +
    scale_radius(range = c(2, 10), limits = c(0, NA)) +
    scale_color_gradient(low = "red", high = "blue") +
    facet_wrap(~ facet, ncol = n_col) + 
      theme(
        strip.text.x     = element_text(),
        panel.background = element_rect(fill = "white"),
        plot.title       = element_text(hjust=0.5)
      )

  ggsave(paste(facet[2], "_WC.jpeg", sep = ""), path = "Plots")
  return(g)
}
```

## Course Level
```{r tf-idf per course}
tdm_top <- d_overview_stem %>%
  filter(`Calendar Year` == "2018-2019") %>%
  count(Code, `Calendar Year`, word, sort = T) %>%
  bind_tf_idf(term = word, document = Code, n = n) %>%
  filter(n >= 2) %>%
  group_by(Code) %>%
  top_n(10, tf_idf) %>%
  ungroup %>%
  filter(Code %in% sample(unique(.$Code), size = 25, replace = F)) # select 25 courses at random

make_barplot(data = tdm_top, facet = Code)
make_WC(data = tdm_top, facet = Code)
```

## Cluster Level
```{r tf-idf per cluster}
tdm_top <- d_overview_stem %>%
  left_join(select(d_course, Code, Cluster), by = "Code") %>%
  filter(`Calendar Year` == "2018-2019",
         !is.na(Cluster)) %>%
  count(Cluster, `Calendar Year`, word, sort = T) %>%
  bind_tf_idf(term = word, document = Cluster, n = n) %>%
  filter(n >= 5) %>%
  group_by(Cluster) %>%
  top_n(10, tf_idf) %>%
  ungroup

# Plots
make_barplot(data = tdm_top, facet = Cluster, n_col = 4)
make_WC(data = tdm_top, facet = Cluster, n_col = 4)
```

## Concentration Level
```{r tf-idf per concentration}
tdm_top <- d_overview_stem %>%
  left_join(select(d_course, Code, Concentration, `Concentration (additional)`), by = "Code") %>%
  gather(key = "key", value = Concentration,
         c("Concentration", "Concentration (additional)"),
         na.rm = T) %>%
  filter(`Calendar Year` == "2018-2019") %>%
  count(Concentration, `Calendar Year`, word, sort = T) %>%
  bind_tf_idf(term = word, document = Concentration, n = n) %>%
  filter(n >= 5) %>%
  group_by(Concentration) %>%
  top_n(10, tf_idf) %>%
  ungroup

# Plots
make_barplot(data = tdm_top, facet = Concentration)
make_WC(data = tdm_top, facet = Concentration)
```

# LDA

## Fitting Model
```{r}
d_overview_cast <- d_overview_stem %>%
  count(Code, word, sort = T) %>%
  cast_dtm(Code,word, n)
```

```{r}
LDA_10 <- LDA(d_overview_cast, k = 10, control = list(seed = 123))
LDA_17 <- LDA(d_overview_cast, k = 17, control = list(seed = 123))
LDA_25 <- LDA(d_overview_cast, k = 25, control = list(seed = 123))
```

## Results

```{r function visualize_LDA, eval = F}
visualize_LDA <- function(results, id_plot = "test", facet = F, topic_names = NULL){
  
  # Setup
  topic_letter <- tibble(topic_number = 1:26,
                         topic_letter = c(topic_names,
                                          paste("Topic", LETTERS[(length(topic_names)+1) : 26])))
  
  # Beta Distribution: term-topic
  term_topic <- tidy(results, matrix = "beta") %>%
    left_join(topic_letter, by = c("topic" = "topic_number")) %>%
    mutate(topic = topic_letter) %>%
    select(-topic_letter)
  
  term_topic %>%
    group_by(topic) %>%
    top_n(10, beta) %>%
    ungroup %>%
    ggplot(aes(x = reorder_within(term, by = beta, within = topic), y = beta, fill = topic)) +
    geom_col(show.legend = F) +
    facet_wrap(~ topic, scales = "free") +
    scale_x_reordered() +
    labs(x = "Terms", y = "Beta", title = "Main Terms of each Topic") +
    coord_flip() +
    theme_light() +
    theme(plot.title = element_text(hjust = 0.5))
  
  ggsave(paste(id_plot, "beta.jpeg"),
         width = 15, height = 10, path = "Plots")
  
  # Gamma Distribution: document-topic
  doc_topic <- tidy(results, matrix = "gamma") %>%
    left_join(topic_letter, by = c("topic" = "topic_number")) %>%
    mutate(topic = topic_letter,
           facet = document) %>%
    select(-c(topic_letter, document))
  
  if(facet) doc_topic <- separate(doc_topic, facet, c("document", "facet"), sep = "_") %>%
    add_count(facet) %>%
    group_by(facet, topic) %>%
    summarise(gamma = sum(gamma)) %>%
    ungroup
  
  # Plot 1
  doc_topic %>%
    filter(gamma > 0.05) %>%
    ggplot(aes(reorder_within(facet, by = gamma, within = topic), y = gamma, fill = facet)) +
    geom_col(show.legend = F) +
    facet_rep_wrap(~ topic, scales = "free",
                   repeat.tick.labels = "bottom") +
    scale_x_reordered() +
    coord_flip() +
    labs(x = "(Group of) Courses", y = "Gamma", title = "Main Courses/Clusters of each Topic") +
    theme_light() +
    theme(axis.text.x = element_text(angle = 90, hjust = 0),
          plot.title = element_text(hjust = 0.5))
  
  ggsave(paste(id_plot, "gamma1.jpeg"),
         width = 15, height = 10, path = "Plots")
  
  # Plot 2
  doc_topic %>%
    filter(gamma > 0.05) %>%
    ggplot(aes(reorder_within(topic, by = gamma, within = facet), y = gamma, fill = topic)) +
    geom_col(show.legend = F) +
    facet_rep_wrap(~ facet, scales = "free",
                   repeat.tick.labels = "bottom") +
    scale_x_reordered() +
    coord_flip() +
    labs(x = "Topics", y = "Gamma", title = "Main Topics of each Courses/Cluster") +
    theme_light() +
    theme(axis.text.x = element_text(angle = 90, hjust = 0),
          plot.title = element_text(hjust = 0.5))

  
  ggsave(paste(id_plot, "gamma2.jpeg"),
         width = 15, height = 10, path = "Plots")
  
}
```

```{r visualization LDA, eval = F}
visualize_LDA(LDA_SCI_2 , id_plot = "SCI, k = 2" )
visualize_LDA(LDA_SCI_5 , id_plot = "SCI, k = 5" )
visualize_LDA(LDA_SCI_10, id_plot = "SCI, k = 10")

visualize_LDA(LDA_cluster_10, id_plot = "Cluster, k = 10", facet = T)
visualize_LDA(LDA_cluster_17, id_plot = "Cluster, k = 17", facet = T)
visualize_LDA(LDA_cluster_25, id_plot = "Cluster, k = 25", facet = T)

visualize_LDA(LDA_cluster_10, id_plot = "Cluster, k = 10 with labelled topics", facet = T,
              topic_names = c("Psychology & Information", "Economics and Development", "Biology", "Chemistry and Math",
                              "Sociology", "Law", "Research", "International Politics",
                              "Philosophy", "Humanities"))

visualize_LDA(LDA_cluster_17, id_plot = "Cluster, k = 17 with labelled topics", facet = T,
              topic_names = c("Science/Knowledge", "Psycho", "Biology", "Chemistry", "Culture",
                              "Conflict", "Research", "Foreign Policy", "Arts", "Literature",
                              "Communication Skills", "Law", "Humanities", "Computer", "Economics", 
                              "Math", "Management and ?"))
visualize_LDA(LDA_cluster_25, id_plot = "Cluster, k = 25 with labelled topics", facet = T,
              topic_names = c(
                "Information", "Psycho", "Bio", "Chem", "Sociology",
                "History", "skills", "Europe", "Philosophy", "IR",
                "Conference", "Law", "Media", "Philosophy", "Economics",
                "Math", "Management and Literature", "Entrepreneurship", "Conflict", "Research",
                "Arts", "Computer Science", "Policy?", "Physiology", "Qual. Res."))
```