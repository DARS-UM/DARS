---
title: "Topic Scores"
author: "DARS"
date: "2/18/2019"
output: pdf_document
---
#Set up
##Libraries
```{r libraries}
library(tidyverse) #already in Pillar2
```

##Raw Data
```{r setup1, include=FALSE}
#
##Import d_course and d_transcript
load("Output/data_pillar_1.RDATA") #check if included in pillar 2
```

```{r setup2, include = FALSE}
#
##Import LDA_models
start.time <- Sys.time()
load("Output/topic_model_gb.RDATA") #this takes a long time, won't be needed in pillar 2
end.time <- Sys.time()
print(start.time-end.time)
```

Cropping model and getting distributions:
```{r}
#select number of topics
n_topics_overview <- 36
n_topics_manual   <- 40 

#Crop models
TM_overview <- topic_model_gb %>%
  filter(n_topic== n_topics_overview) 

TM_manual   <- topic_model_gb %>%
  filter(n_topic== n_topics_manual)

#Distributions
distribution <- list()

distribution$beta$overview  <- TM_overview %>% pull(b_overview)
distribution$beta$manual    <- TM_manual   %>% pull(b_manual)

distribution$gamma$overview <- TM_overview %>% pull(g_overview)
distribution$gamma$manual   <- TM_manual   %>% pull(g_manual)

```

##Models in list:
```{r models in list, eval = FALSE}
LDA_models <- list()
#LDA_models$description <- LDA_description_35 #this is the old code

LDA_models$overview <- topic_model %>% 
  filter (n_topic == 36) %>%
  pull(TM_overview)

LDA_models$manual <- topic_model %>% 
  filter (n_topic == 40) %>%
  pull(TM_manual)

#rm(topic_model)
```

## Getting Functions (gamma and beta) this is silenced because we clean before importing
```{r getting functions, eval = FALSE}
get_beta <- function(results){
  
  tidy(results, matrix = "beta")           %>%
    mutate(topic = paste("Topic", topic) ) %>%
      arrange(topic, desc(beta) )
  
}

get_gamma <- function(results){
  
  tidy(results, matrix = "gamma")          %>%
    mutate(topic = paste("Topic", topic) ) %>%
      arrange(topic, desc(gamma) )
}

```

##Getting applied (gamma and beta) 
```{r getting beta and gamma, eval = FALSE}
distribution <- list()

distribution$beta <- lapply(
  LDA_models,
  get_beta
)

distribution$gamma <- lapply(
  LDA_models,
  get_gamma
)

```

##Inspect topics
THE TOPICS ARE SUPPER STRANGE!
```{r inspect topics}

inspect_topics <- function(d_beta){
  data.frame(d_beta) %>%
    group_by(topic) %>%
    top_n(10, beta)
  
}

topics <-  lapply(
  distribution$beta,
  inspect_topics
)
 
#
##View
#View(topics$manual)
```

##Selectig keywords
```{r}
get_top_words <- function(d_beta, n = 3){
  data.frame(d_beta) %>%
    group_by(topic) %>%
    top_n(n, beta) %>%
    pull(term)%>%
    unique
}

kw <- lapply(
  distribution$beta,
  get_top_words
)
```
###Convenience vectors
```{r}
# set seed
set.seed(1)

#
## All courses
course_all <- d_course %>%
  inner_join(
    d_transcript,
    by = "Course ID"
  ) %>%
  distinct(
    `Course ID`
  ) %>%
  # remove semester abroad, skills and projects
  filter(
    ! str_detect(`Course ID`, pattern = "SA|SKI|PRO")
  ) %>%
  pull

#
##courses following_semester
course_following_semester <- sample(
  x       = course_all,
  size    = 60,
  replace = FALSE
  ) %>% sort
```

### Saving files for APP
```{r keywords}
save(distribution, kw, course_all, course_following_semester,
     file = "App/Recommender System/data_topic_models.RDATA")
```
